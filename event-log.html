<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutomatUp - Event Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex-shrink-0">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-700">
                <img src="logo.png" alt="AutomatUp Logo" class="h-10 w-auto">
            </div>
            
            <!-- Navigation Menu -->
            <nav class="mt-6">
                <ul class="space-y-2 px-4">
                    <li>
                        <a href="dashboard.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="analysis.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li>
                        <a href="reports.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="fas fa-file-alt"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                    <li>
                        <a href="event-log.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg bg-blue-600 text-white">
                            <i class="fas fa-list-alt"></i>
                            <span>Event Log</span>
                        </a>
                    </li>
                    <li>
                        <a href="feed.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="fas fa-video"></i>
                            <span>Feed</span>
                        </a>
                    </li>
                    <li>
                        <a href="settings.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li>
                        <a href="config.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="fas fa-sliders-h"></i>
                            <span>Config</span>
                        </a>
                    </li>
                    <li>
                        <a href="profile.html" class="flex items-center space-x-3 py-3 px-4 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200">
                            <i class="far fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Bar -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Search Bar -->
                    <div class="flex-1 max-w-md">
                        <div class="relative">
                            <input
                                type="text"
                                placeholder="Search events..."
                                id="searchInput"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Right Side Icons -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-gray-600">
                            <i class="far fa-clock"></i>
                            <span class="text-sm" data-time>05:43pm</span>
                        </div>
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="far fa-bell"></i>
                        </button>
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="far fa-user"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 overflow-auto p-6">
                <!-- Breadcrumb -->
                <nav class="mb-6">
                    <div class="flex items-center space-x-2 text-sm">
                        <a href="dashboard.html" class="text-gray-500 hover:text-gray-700">Dashboard</a>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <span class="text-gray-700">Event Log</span>
                    </div>
                </nav>

                <!-- Page Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Event Log</h1>
                        <p class="text-gray-600 mt-2">Monitor and track all system events and activities</p>
                    </div>
                    
                    <button onclick="exportEvents()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                        <i class="fas fa-download mr-2"></i>
                        Export CSV
                    </button>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                            <input type="date" id="fromDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                            <input type="date" id="toDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Type</label>
                            <select id="eventTypeFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Events</option>
                                <option value="Vehicle Arrival">Vehicle Arrival</option>
                                <option value="Loading Complete">Loading Complete</option>
                                <option value="Violation Detected">Violation Detected</option>
                                <option value="Count Mismatch">Count Mismatch</option>
                                <option value="Security Alert">Security Alert</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Area</label>
                            <select id="areaFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Areas</option>
                                <option value="Dock A">Dock A</option>
                                <option value="Dock B">Dock B</option>
                                <option value="Warehouse">Warehouse</option>
                                <option value="Loading Bay">Loading Bay</option>
                                <option value="Gate Area">Gate Area</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mt-4 pt-4 border-t">
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="showPinnedOnly" class="mr-2">
                                <span class="text-sm font-medium text-gray-700">Show Pinned Only</span>
                            </label>
                            <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-700">
                                Clear All Filters
                            </button>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span id="eventCount">50</span> events found
                        </div>
                    </div>
                </div>

                <!-- Events Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S.No</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Area</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Events will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="bg-white px-6 py-3 border-t border-gray-200 flex items-center justify-between">
                        <div class="flex items-center text-sm text-gray-500">
                            Showing <span id="showingFrom">1</span> to <span id="showingTo">10</span> of <span id="totalEvents">50</span> events
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="changePage(-1)" id="prevBtn" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <div class="flex items-center space-x-1" id="pageNumbers">
                                <!-- Page numbers will be populated here -->
                            </div>
                            <button onclick="changePage(1)" id="nextBtn" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Event Detail Modal -->
    <div id="eventDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold" id="modalEventName">Event Details</h3>
                <button onclick="hideEventDetailModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date & Time</label>
                        <p class="text-sm text-gray-900" id="modalDateTime">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Area</label>
                        <p class="text-sm text-gray-900" id="modalArea">-</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Action Points</label>
                    <div id="modalActionPoints" class="flex flex-wrap gap-2">
                        <!-- Action points will be populated here -->
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Details</label>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-sm text-gray-900" id="modalDetails">-</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 pt-4">
                    <button onclick="viewVideo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-play mr-2"></i>
                        View Video
                    </button>
                    <button onclick="downloadReport()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-download mr-2"></i>
                        Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/shared.js"></script>
    <script>
        // Event Log Page Logic
        class EventLogPage {
            constructor() {
                this.events = [];
                this.filteredEvents = [];
                this.currentPage = 1;
                this.eventsPerPage = 10;
                this.init();
            }

            init() {
                this.loadEvents();
                this.setDefaultDates();
                this.renderEvents();
                this.bindEvents();
            }

            loadEvents() {
                this.events = window.appState.getEvents();
                this.filteredEvents = [...this.events];
                // Sort by pinned first, then by date
                this.sortEvents();
            }

            setDefaultDates() {
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
                document.getElementById('toDate').value = today.toISOString().split('T')[0];
            }

            sortEvents() {
                this.filteredEvents.sort((a, b) => {
                    // Pinned events first
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    
                    // Then by date (newest first)
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA;
                });
            }

            renderEvents() {
                const tbody = document.getElementById('eventsTableBody');
                const startIndex = (this.currentPage - 1) * this.eventsPerPage;
                const endIndex = startIndex + this.eventsPerPage;
                const pageEvents = this.filteredEvents.slice(startIndex, endIndex);

                tbody.innerHTML = pageEvents.map((event, index) => {
                    const globalIndex = startIndex + index + 1;
                    const severityClass = this.getSeverityClass(event.severity);
                    
                    return `
                        <tr class="hover:bg-gray-50 ${event.pinned ? 'bg-blue-50' : ''}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${globalIndex}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${window.utils.formatDate(event.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 rounded-full ${severityClass}"></div>
                                    <span class="text-sm font-medium text-gray-900">${event.eventName}</span>
                                    ${event.pinned ? '<i class="fas fa-thumbtack text-blue-600 text-xs"></i>' : ''}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${event.eventArea}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${event.time}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div class="flex items-center space-x-2">
                                    <button onclick="togglePin(${event.id})" class="text-gray-400 hover:text-blue-600" title="Pin Event">
                                        <i class="fas fa-thumbtack ${event.pinned ? 'text-blue-600' : ''}"></i>
                                    </button>
                                    <button onclick="showEventDetail(${event.id})" class="text-blue-600 hover:text-blue-700" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="viewEventVideo(${event.id})" class="text-green-600 hover:text-green-700" title="View Video">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                this.updatePagination();
                this.updateEventCount();
            }

            getSeverityClass(severity) {
                switch (severity) {
                    case 'high': return 'bg-red-500';
                    case 'medium': return 'bg-yellow-500';
                    case 'low': return 'bg-green-500';
                    default: return 'bg-gray-500';
                }
            }

            updatePagination() {
                const totalPages = Math.ceil(this.filteredEvents.length / this.eventsPerPage);
                const startIndex = (this.currentPage - 1) * this.eventsPerPage + 1;
                const endIndex = Math.min(this.currentPage * this.eventsPerPage, this.filteredEvents.length);

                document.getElementById('showingFrom').textContent = startIndex;
                document.getElementById('showingTo').textContent = endIndex;
                document.getElementById('totalEvents').textContent = this.filteredEvents.length;

                // Update page numbers
                const pageNumbers = document.getElementById('pageNumbers');
                pageNumbers.innerHTML = '';
                
                for (let i = Math.max(1, this.currentPage - 2); i <= Math.min(totalPages, this.currentPage + 2); i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `px-3 py-1 border rounded text-sm ${
                        i === this.currentPage 
                            ? 'bg-blue-600 text-white border-blue-600' 
                            : 'border-gray-300 hover:bg-gray-50'
                    }`;
                    button.onclick = () => this.goToPage(i);
                    pageNumbers.appendChild(button);
                }

                // Update navigation buttons
                document.getElementById('prevBtn').disabled = this.currentPage === 1;
                document.getElementById('nextBtn').disabled = this.currentPage === totalPages;
            }

            updateEventCount() {
                document.getElementById('eventCount').textContent = this.filteredEvents.length;
            }

            bindEvents() {
                // Search
                const searchInput = document.getElementById('searchInput');
                const searchHandler = window.utils.debounce(() => {
                    this.applyFilters();
                }, 300);
                searchInput.addEventListener('input', searchHandler);

                // Filters
                ['fromDate', 'toDate', 'eventTypeFilter', 'areaFilter', 'showPinnedOnly'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.applyFilters();
                    });
                });
            }

            applyFilters() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                const eventType = document.getElementById('eventTypeFilter').value;
                const area = document.getElementById('areaFilter').value;
                const showPinnedOnly = document.getElementById('showPinnedOnly').checked;

                this.filteredEvents = this.events.filter(event => {
                    // Search filter
                    if (searchTerm && !event.eventName.toLowerCase().includes(searchTerm) && 
                        !event.eventArea.toLowerCase().includes(searchTerm)) {
                        return false;
                    }

                    // Date filters
                    if (fromDate && event.date < fromDate) return false;
                    if (toDate && event.date > toDate) return false;

                    // Event type filter
                    if (eventType && event.eventName !== eventType) return false;

                    // Area filter
                    if (area && event.eventArea !== area) return false;

                    // Pinned only filter
                    if (showPinnedOnly && !event.pinned) return false;

                    return true;
                });

                this.sortEvents();
                this.currentPage = 1;
                this.renderEvents();
            }

            changePage(direction) {
                const totalPages = Math.ceil(this.filteredEvents.length / this.eventsPerPage);
                this.currentPage = Math.max(1, Math.min(totalPages, this.currentPage + direction));
                this.renderEvents();
            }

            goToPage(page) {
                this.currentPage = page;
                this.renderEvents();
            }

            togglePin(eventId) {
                const event = window.appState.toggleEventPin(eventId);
                if (event) {
                    this.loadEvents();
                    this.applyFilters();
                    window.utils.showToast(
                        `Event ${event.pinned ? 'pinned' : 'unpinned'}`, 
                        'info'
                    );
                }
            }

            exportEvents() {
                const exportData = this.filteredEvents.map(event => ({
                    'S.No': event.id,
                    'Date': event.date,
                    'Event Name': event.eventName,
                    'Event Area': event.eventArea,
                    'Time': event.time,
                    'Severity': event.severity,
                    'Pinned': event.pinned ? 'Yes' : 'No',
                    'Details': event.details
                }));

                window.utils.exportToCSV(exportData, 'event_log_export.csv');
                window.utils.showToast('Events exported successfully!', 'success');
            }
        }

        // Global functions
        function changePage(direction) {
            window.eventLogPage.changePage(direction);
        }

        function togglePin(eventId) {
            window.eventLogPage.togglePin(eventId);
        }

        function showEventDetail(eventId) {
            const event = window.eventLogPage.events.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('modalEventName').textContent = event.eventName;
            document.getElementById('modalDateTime').textContent = `${window.utils.formatDate(event.date)} at ${event.time}`;
            document.getElementById('modalArea').textContent = event.eventArea;
            document.getElementById('modalDetails').textContent = event.details;

            // Populate action points
            const actionPointsContainer = document.getElementById('modalActionPoints');
            actionPointsContainer.innerHTML = event.actionPoints.map(point => `
                <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
                    ${point}
                </span>
            `).join('');

            document.getElementById('eventDetailModal').classList.remove('hidden');
        }

        function hideEventDetailModal() {
            document.getElementById('eventDetailModal').classList.add('hidden');
        }

        function viewEventVideo(eventId) {
            window.utils.showToast('Video playback feature coming soon!', 'info');
        }

        function viewVideo() {
            window.utils.showToast('Video playback feature coming soon!', 'info');
        }

        function downloadReport() {
            window.utils.showToast('Report download feature coming soon!', 'info');
        }

        function exportEvents() {
            window.eventLogPage.exportEvents();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('eventTypeFilter').value = '';
            document.getElementById('areaFilter').value = '';
            document.getElementById('showPinnedOnly').checked = false;
            window.eventLogPage.setDefaultDates();
            window.eventLogPage.applyFilters();
            window.utils.showToast('Filters cleared', 'info');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            window.eventLogPage = new EventLogPage();
        });
    </script>
</body>
</html>
